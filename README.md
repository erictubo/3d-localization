# 3D Localization: Visual Localization against 3D models

This repository implements data generation from 3D models, particularly rendering CAD meshes in Blender and reading from COLMAP SFM models, as well as data conversion for localization pipelines MeshLoc and GLACE.

Table of files & content

### Main files

| File | Description |
| --- | --- |
| [main.py](src/main.py) | Main file for rendering and data conversion |
| [colmap_model.py](src/colmap_model.py) | Reading specific data from COLMAP model files and writing to text files, vice versa |
| [data.py](src/data.py) | Data structure: paths and file names for 3D models |
[features.py](src/features.py) | Feature extraction and matching for MeshLoc, using HLoc submodule |
| [glace_conversion.py](src/glace_conversion.py) | Data conversion for GLACE, reading from rendered data and COLMAP model files |
| [model_conversion.py](src/model_conversion.py) | Conversion between coordinate frames of CAD and COLMAP models, between data formats (e.g. depth maps) |
| [visualization.py](src/visualization.py) | Visualization functions for overlays, depth maps, and scene coordinates |

## Interface files

| File | Description |
| --- | --- |
| [interface_blender.py](src/interface_blender.py) | Blender interface for rendering, used by [main.py](src/main.py) for rendering of COLMAP poses |
| [interface_meshloc.py](src/interface_meshloc.py) | Interface for MeshLoc, reading and writing data for localization (in progress) |

### COLMAP files

| File | Description |
| --- | --- |
| [colmap/read_write_model.py](src/colmap/read_write_model.py) | Reading and writing COLMAP model files (copied from COLMAP repository) |

### Blender files

| File | Description |
| --- | --- |
| [blender/render_database.py](src/blender/render_database.py) | Rendering using automatic orbit poses |
| [blender/render_query.py](src/blender/render_query.py) | Rendering from COLMAP model poses |
| [blender/renderer.py](src/blender/renderer.py) | Blender rendering functions |
| [blender/data.py](src/blender/data.py) | Data paths |
| [.vscode/tasks.json](.vscode/tasks.json) | Task definition for Blender rendering |

### Other files

| [copy_distance_below.py](src/copy_distance_below.py) | Copying images with distance below threshold, used for testing on Notre Dame dataset |




[.vscode/tasks.json](.vscode/tasks.json)

Change command to location of Blender executable, e.g. "/snap/bin/blender" for Linux if installed via Snap
```json
"command": "/Applications/Blender.app/Contents/MacOS/Blender",
```

## Setup

### HLoc

Hloc as submodule for global feature extraction required by MeshLoc

1. Follow hloc setup steps
2. Use hloc conda environment + install additional dependencies

```​
conda activate hloc_env

pip install pyquaternion transformations openexr
```

### Immatch (required for MeshLoc)

- Python 3.8
- pycolmap
- cython
- ...

### GLACE

Follow glace setup to glace_env

```
conda activate glace_env

pip install torch=2.2.2 torchvision==0.17.1
```

### Device-specific directories

blender_path in tasks.json and interface_blender.py

- macOS: "/Applications/Blender.app/Contents/MacOS/Blender"
- Linux: "/snap/bin/blender"


### 3D Models

Download ...
Registration ...
Blender import & settings ...

- Name "Model"


## A. Data Preparation

### Rendering

Format: Blender CAD

#### Input

3D Models

- Image database with COLMAP SFM model in `inputs/database/images`
- Blender file with CAD model in
- Registration matrix between SFM reference and CAD model placed in `ground truth / T_sfm_cad.txt`


#### Output: Data Structure

- images/*.png – rendered images
- depth/*.exr – depth maps (EXR format)
- intrinsics/*.txt – intrinsics (list format: `w, h, f, f_unit, cx, cy`)
- poses/*.txt – poses (Blender CAD frame)
- bounding_box – CAD model 3D corner points (CAD frame) for data verification

When rendering ground truth query poses from the main file ([main.py](src/main.py)), the output is saved to `ground truth/renders/`.

### Data Conversion for Localization

Localization in COLMAP SFM format

Conversion via transformation matrix $T_{ref}$ 

#### Manual Changes

1. rename depth files by replacing trailing "0001.exr" with ".exr" (name automatically generated by Blender)
2. Move query images to `inputs/query/images/*`
3. Move registration matrix to `ground truth / T_sfm_cad.txt`

#### Data Conversion Output

- input/
    - database/
        - depth/*.npz – depth maps (NPZ format)
        - cameras.txt – intrinsics (COLMAP format)
        - images.txt – poses (COLMAP format, SFM frame)
        - points3D.txt – CAD model corner points (COLMAP format, SFM frame) for data verification
    - query/
        - queries.txt – list of queries with intrinsics (for MeshLoc)
- output/
    - features/
        - pairs-from-retrieval.txt – top K matches from image retrieval (via HLoc)
        - pairs-from-retrieval-meshloc.txt – " (for MeshLoc)

#### Data Conversion for GLACE

Use script glace_conversion.py ...


## B. Localization Pipelines

### MeshLoc (Mesh-based Localization)

#### Parameters

- K for number of top matches to use: e.g. 25
- Method: e.g. patch2pix
- Config: e.g. aachen_v1.1
- ...

#### Data Structure

- input/
    - database/
        - images/*.png
        - depth/*.npz – depth maps (NPZ format)
        - cameras.txt – intrinsics (COLMAP format)
        - images.txt – poses (COLMAP format)
    - query/
        - images/
        - queries.txt
- output/
    - features/
        - retrieval-pairs.txt – global features from image retrieval step (via HLoc)
    - meshloc_matches/
        - *.npy – local feature matches for each query-database pair
    - meshloc_out/
        - poses.txt – list of queries with output poses (SFM frame) (quaternion, translation)

#### MeshLoc Output: Data Structure

### GLACE (Scene Coordinate Regression)

#### Parameters

#### Data Structure

Pre-trained image retrieval model

Reading data based on sorted sequence, not by looking up filenames

- test/
    - calibration/*.txt – intrinsics (camera matrix format)
    - poses/*.txt – poses (transformation matrix format)
    - rgb/*.png – images
    - features.npy – global features extracted via R2Former
- train/
    - "
- output
    - <scene>.pt


## C. Post-Processing

### Data Conversion for Evaluation

- output/
    - cad_cam_poses.txt – list of queries with camera poses (CAD frame) (translation, quaternion)

### Rendering & Overlays

- ground truth/
    - renders/
        - [see Rendering Output] for each query GT pose
    - overlays/
        - *.jpg – overlaid query and output image
- output
    - renders/
        - [see Rendering Output] for each query output pose
    - overlays/
        - *.jpg – overlaid query and rendered output pose

### Evaluation